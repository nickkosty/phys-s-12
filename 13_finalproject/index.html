<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PHYS S‑12 — Final Project: Shopify Split‑Flap Sales Counter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../style.css" rel="stylesheet" />
  <style>
    .section{margin-top:28px}
    .pill{display:inline-block;background:#eee;border-radius:999px;padding:4px 10px;margin:2px 6px 0 0;font-size:.9rem}
    code,pre{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    pre{background:#0f0f12;color:#e7e7e7;padding:14px;border-radius:10px;overflow:auto}
    .pair{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .frame{width:100%;aspect-ratio:2/3;background:#000;border-radius:12px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.18)}
    video,img{width:100%;height:100%;object-fit:cover}
    .step{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;align-items:start}
    .step.reverse{grid-template-columns:.85fr 1.15fr}
    .caption{color:#6b6b6b;font-size:.95rem;margin-top:6px}
    .files a{display:inline-block;margin:6px 10px 0 0}
    @media (max-width: 992px){
      .pair,.step,.step.reverse{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
<nav class="navbar navbar-expand-sm navbar-dark" style="color:#EEE7E8;">
  <div class="container-fluid" style="align-items:center;justify-content:center;">
    <div class="flexrow">
      <h2 class="nav-title">PHYS S‑12 Summer 2025</h2>
    </div>
    <div class="navbar-nav">
      <h4><a class="nav-link" href="../index.html">Home</a></h4>
      <h4><a class="nav-link" href="../about.html">About</a></h4>
    </div>
  </div>
</nav>

<main class="container py-4">

  <h3>Final Project: Shopify Split‑Flap Sales Counter</h3>
  <p>
    A mechanical split‑flap counter that flips every time a new Shopify order hits. Stack:
    ESP32 + ULN2003 steppers + A3144 hall sensors. Data path: <b>Shopify → Firebase RTDB → ESP32</b>.
    I originally planned 5 digits but ran out of pins (didn’t want to add an I²C expander), so I made a clean <b>4‑digit</b> build.
    It <b>calibrates on startup</b> and then jumps to whatever value is in Firebase. Fast, reliable, and very fun.
  </p>

  <!-- HERO: MVP first (working + calibration) -->
  <div class="section pair">
    <div class="frame">
      <video src="./media/mvpworking.webm" autoplay muted loop playsinline></video>
    </div>
    <div class="frame">
      <video src="./media/mvpcalibration.webm" autoplay muted loop playsinline></video>
    </div>
  </div>
  <p class="caption mt-2">
    I started with an MVP (one digit) to prove the mechanics + firmware. Full MVP page:
    <a href="https://nickkosty.github.io/phys-s-12/07_outputs/index.html" target="_blank" rel="noopener">nickkosty.github.io/phys-s-12/07_outputs</a>
  </p>

  <div class="section">
    <span class="pill">ESP32</span>
    <span class="pill">Firebase RTDB</span>
    <span class="pill">Shopify Webhooks</span>
    <span class="pill">ULN2003 + 28BYJ‑48</span>
    <span class="pill">A3144 Hall Sensors</span>
    <span class="pill">Laser‑cut Enclosure</span>
    <span class="pill">Vinyl‑cut Numbers</span>
  </div>

  <!-- STEP 1: Print parts -->
  <div class="section step">
    <div>
      <h4>1) Print all parts</h4>
      <p>
        After the MVP, I printed the full set for four digits: flap wheels, gears, frames, hubs, and caps.
        Everything is modular so a digit is copy‑paste.
      </p>
    </div>
    <div>
      <div class="frame"><img src="./media/almostfinished.JPG" alt="Printed digits laid out"></div>
      <p class="caption">Fresh off the printer and dry‑fit on the bench.</p>
    </div>
  </div>

  <!-- STEP 2: Vinyl numbers -->
  <div class="section step reverse">
    <div>
      <div class="frame"><img src="./media/vinylcut.JPG" alt="Vinyl cut numbers"></div>
      <div class="frame" style="margin-top:12px;"><img src="./media/vinylapply.JPG" alt="Applying vinyl"></div>
    </div>
    <div>
      <h4>2) Vinyl‑cut the numbers</h4>
      <p>
        I cut clean numerals and applied them to both sides of each flap. Keeping alignment consistent across all flaps
        was the key to it looking “real.”
      </p>
    </div>
  </div>

  <!-- STEP 3: Assemble with hall sensors + motors -->
  <div class="section step">
    <div>
      <h4>3) Assemble digits (steppers + hall sensors + magnets)</h4>
      <p>
        Each digit = 28BYJ‑48 + ULN2003 driver + A3144 hall sensor module + tiny magnet on the wheel.
        The hall sensors share the same <b>5 V supply</b> as the drivers; grounds are all common.
      </p>
      <p class="caption">
        <b>Motor IN1..IN4 per digit</b> — Thousands: 19,23,22,21 · Hundreds: 16,17,5,18 · Tens: 27,14,4,13 · Ones: 32,33,25,26<br>
        <b>Hall sensors</b> — Thousands: 39 · Hundreds: 36 · Tens: 34 · Ones: 35 (ESP32 input‑only pins)
      </p>
    </div>
    <div>
      <div class="frame"><img src="./media/hallsensor.JPG" alt="Hall sensor close-up"></div>
    </div>
  </div>

  <!-- STEP 4: Wire harness -->
  <div class="section step reverse">
    <div>
      <div class="frame"><img src="./media/almostfinalwiring.JPG" alt="Almost final wiring"></div>
      <div class="frame" style="margin-top:12px;"><img src="./media/wiring.JPG" alt="Final wiring inside the box"></div>
    </div>
    <div>
      <h4>4) Wire it up</h4>
      <p>
        Built a harness for four drivers and four hall sensors, zip‑tied it, and tested each digit.
        I did short one driver along the way (RIP), replaced it, and kept rolling.
      </p>
    </div>
  </div>

  <!-- STEP 5: Enclosure -->
  <div class="section step">
    <div>
      <h4>5) Laser‑cut the enclosure</h4>
      <p>
        Simple plywood enclosure. Modules hot‑glue in flush, wiring tucked behind. I still need a clean
        panel‑mount hole for the power jack, but the structure is sturdy and accessible.
      </p>
    </div>
    <div>
      <div class="frame"><video src="./media/lasercuttingenclosure.webm" autoplay muted loop playsinline></video></div>
    </div>
  </div>

  <!-- STEP 6: Final assembly into enclosure -->
  <div class="section step reverse">
    <div>
      <div class="frame"><video src="./media/finalwiringinenclosure.webm" autoplay muted loop playsinline></video></div>
      <div class="frame" style="margin-top:12px;"><img src="./media/finalwiringpic.JPG" alt="Final bench shot"></div>
    </div>
    <div>
      <h4>6) Drop everything in the box</h4>
      <p>
        With wiring cleaned up, everything dropped in and lined up nicely. Looks legit and serviceable.
      </p>
    </div>
  </div>

  <!-- STEP 7: Calibrate + final behavior -->
  <div class="section step">
    <div>
      <h4>7) Calibrate + final behavior</h4>
      <p>
        On boot, all digits home, nudge past the magnet edge for repeatability, then jump to the Firebase value.
        Editing <code>/shopify/orderCount</code> in RTDB live‑updates the display.
      </p>
    </div>
    <div>
      <div class="frame"><video src="./media/calibrationonstartup.webm" autoplay muted loop playsinline></video></div>
      <div class="frame" style="margin-top:12px;"><video src="./media/orderincrement.webm" autoplay muted loop playsinline></video></div>
    </div>
  </div>

  <!-- CLOUD + RULES -->
  <div class="section">
    <h4>Cloud flow</h4>
    <p>
      Shopify → webhook (Node/Express on Render) → Firebase Realtime DB. Each new order pushes a compact
      order object and atomically increments <code>/shopify/orderCount</code>. The ESP32 polls that absolute value and
      rotates the necessary digits.
    </p>
    <h6 class="mt-2">Firebase Rules (dev)</h6>
<pre><code>{
  "rules": {
    "shopify": {
      "orderCount": { ".read": true, ".write": true },
      "orders":     { ".read": true, ".write": true }
    }
  }
}
</code></pre>
  </div>

  <!-- FULL CODE SNIPPETS -->
  <div class="section">
    <h4>server.js (full)</h4>
<pre><code>const express = require('express');
const bodyParser = require('body-parser');
const admin = require('firebase-admin');
const crypto = require('crypto');
const app = express();

// Verify Shopify webhook signature
function verifyShopifyWebhook(req, res, buf) {
  const hmacHeader = req.get('X-Shopify-Hmac-Sha256');
  const generatedHmac = crypto
    .createHmac('sha256', process.env.SHOPIFY_WEBHOOK_SECRET)
    .update(buf, 'utf8')
    .digest('base64');
  if (generatedHmac !== hmacHeader) {
    throw new Error('Webhook signature mismatch');
  }
}

// Middleware
app.use(bodyParser.json({ verify: verifyShopifyWebhook }));

// Firebase config
const serviceAccount = {
  type: "service_account",
  project_id: process.env.FIREBASE_PROJECT_ID,
  private_key: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n'),
  client_email: process.env.FIREBASE_CLIENT_EMAIL,
  token_uri: "https://oauth2.googleapis.com/token",
};

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: 'https://shopify-counter-688ee-default-rtdb.firebaseio.com',
});

const db = admin.database();

// Webhook endpoint
app.post('/webhook', async (req, res) => {
  const order = req.body;

  const filteredData = {
    order_id: order.id,
    created_at: order.created_at,
    email: order.email,
    name: order.name,
    total_price: order.total_price,
    currency: order.currency,
    line_items: order.line_items.map(item => ({
      title: item.title,
      quantity: item.quantity,
      price: item.price,
    })),
    shipping_address: order.shipping_address
      ? {
          name: order.shipping_address.name,
          address1: order.shipping_address.address1,
          city: order.shipping_address.city,
          zip: order.shipping_address.zip,
          province: order.shipping_address.province,
          country: order.shipping_address.country,
        }
      : null,
  };

  console.log('✅ Order received:', filteredData);

  try {
    // Push order
    await db.ref('shopify/orders').push(filteredData);

    // Atomically increment orderCount
    await db.ref('shopify/orderCount').transaction(current => {
      return (current || 0) + 1;
    });

    res.status(200).send('OK');
  } catch (err) {
    console.error('❌ Firebase error:', err);
    res.status(500).send('Error');
  }
});

// Start server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`🚀 Server running on port ${PORT}`));
</code></pre>
  </div>

  <div class="section">
    <h4>ESP32 firmware (full)</h4>
<pre><code>#include &lt;WiFi.h&gt;
#include &lt;FirebaseESP32.h&gt;
#include &lt;Preferences.h&gt;

#define WIFI_SSID     "MAKERSPACE"
#define WIFI_PASSWORD "12345678"
#define FIREBASE_HOST "shopify-counter-688ee-default-rtdb.firebaseio.com"
#define FIREBASE_AUTH "fb4973afa5c5432a4a51b2fc02b43eb4c97018ed"

// ----- Firebase -----
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// ----- NVS -----
Preferences prefs;

// digit index: 0=thousands, 1=hundreds, 2=tens, 3=ones

// motors (ULN2003 IN1..IN4)
const int motorPins[4][4] = {
  {19, 23, 22, 21},  // thousands
  {16, 17,  5, 18},  // hundreds
  {27, 14,  4, 13},  // tens
  {32, 33, 25, 26}   // ones
};

// halls (A3144 modules -> 5V modules feeding ESP32 input-only pins)
const int hallPins[4] = {39, 36, 34, 35}; // TH, H, T, O
const bool HALL_ACTIVE_LOW = true;

// motion params (tune stepsPerDigit per wheel if needed)
int stepsPerDigit[4] = {420, 420, 420, 420};
const int stepIntervalMs = 2;   // stepping speed (bigger = slower)
const int homeNudgeSteps = 6;   // small push after leaving magnet

// half-step
const int halfStep[8][4] = {
  {1,0,0,0},{1,1,0,0},{0,1,0,0},{0,1,1,0},
  {0,0,1,0},{0,0,1,1},{0,0,0,1},{1,0,0,1}
};

// state
int currentDigits[4] = {0,0,0,0};
int lastShown = 0;
unsigned long lastPoll = 0;
const unsigned long firebaseInterval = 800;

// ------------- helpers -------------
inline void drivePhase(int d, int phase){
  for (int i=0;i&lt;4;i++) digitalWrite(motorPins[d][i], halfStep[phase][i]);
}
inline void motorOff(int d){
  for (int i=0;i&lt;4;i++) digitalWrite(motorPins[d][i], LOW);
}
inline bool hallActive(int d){
  int v = digitalRead(hallPins[d]);
  return HALL_ACTIVE_LOW ? (v == LOW) : (v == HIGH);
}

// blocking step (ONE DIGIT ONLY)
void stepForward(int d, int steps){
  for (int s=0; s&lt;steps; s++){
    drivePhase(d, s % 8);
    delay(stepIntervalMs);
  }
  motorOff(d);
}

// home a single digit (blocking)
bool homeDigit(int d){
  Serial.printf("🔧 Homing digit %d…\n", d);
  long s = 0;
  unsigned long t0 = millis();

  // seek magnet
  while (!hallActive(d)){
    drivePhase(d, s % 8); s++; delay(stepIntervalMs);
    if (millis() - t0 &gt; 8000){ Serial.println("  ⚠️ timeout seeking magnet"); motorOff(d); return false; }
  }

  // leave magnet
  t0 = millis();
  while (hallActive(d)){
    drivePhase(d, s % 8); s++; delay(stepIntervalMs);
    if (millis() - t0 &gt; 3000){ Serial.println("  ⚠️ timeout leaving magnet"); motorOff(d); return false; }
  }

  stepForward(d, homeNudgeSteps);
  currentDigits[d] = 0;
  motorOff(d);
  Serial.printf("  ✅ digit %d homed at 0\n", d);
  return true;
}

// home all digits SEQUENTIALLY (one-by-one)
void homeAll(){
  for (int d=0; d&lt;4; d++){
    homeDigit(d);
  }
}

// convert number to 4 digits
void numberToDigits(int value, int out[4]){
  if (value &lt; 0) value = 0;
  if (value &gt; 9999) value = 9999;
  out[0] = (value / 1000) % 10;
  out[1] = (value / 100)  % 10;
  out[2] = (value / 10)   % 10;
  out[3] = value % 10;
}

// move ONE digit from current to target (forward only)
void showDigit(int d, int targetDigit){
  int delta = (targetDigit - currentDigits[d] + 10) % 10;
  if (delta){
    stepForward(d, delta * stepsPerDigit[d]);
    currentDigits[d] = targetDigit;
  }
}

// show number SEQUENTIALLY: thousands -> hundreds -> tens -> ones
void showNumber(int value){
  int tgt[4]; numberToDigits(value, tgt);
  for (int d=0; d&lt;4; d++){
    showDigit(d, tgt[d]); // one digit at a time
  }
  lastShown = value;
  prefs.putInt("lastShown", lastShown);
}

// ------------- setup / loop -------------
void setup(){
  Serial.begin(115200);

  // IO
  for (int d=0; d&lt;4; d++){
    for (int i=0;i&lt;4;i++){ pinMode(motorPins[d][i], OUTPUT); digitalWrite(motorPins[d][i], LOW); }
    pinMode(hallPins[d], INPUT);
  }

  // WiFi
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED){ delay(250); Serial.print("."); }
  Serial.println("\\n📶 WiFi connected");

  // Firebase
  config.database_url = FIREBASE_HOST;
  config.signer.tokens.legacy_token = FIREBASE_AUTH;
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  // restore last
  prefs.begin("counter", false);
  lastShown = prefs.getInt("lastShown", 0);
  Serial.printf("🔁 Restored lastShown=%d\\n", lastShown);

  // home sequentially, then go to lastShown, then sync to current cloud value
  homeAll();
  showNumber(lastShown);

  if (Firebase.getInt(fbdo, "/shopify/orderCount")) {
    int now = fbdo.intData();
    showNumber(now);
  }
}

void loop(){
  // poll Firebase (ABSOLUTE number)
  if (millis() - lastPoll &gt;= firebaseInterval){
    lastPoll = millis();

    if (Firebase.getInt(fbdo, "/shopify/orderCount")){
      int target = fbdo.intData();
      if (target != lastShown){
        Serial.printf("🎯 %d → %d\\n", lastShown, target);
        showNumber(target); // one digit at a time
      }
    }
  }
}
</code></pre>
  </div>

  <!-- DOWNLOAD -->
  <div class="section">
    <h4>Download everything</h4>
    <p>All STLs, firmware, server code, and this page’s snippets in one bundle:</p>
    <a class="btn btn-dark" href="./finalprojectfiles.zip" download>Download finalprojectfiles.zip</a>
  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>