<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>PHYS S-12: Intro to Digital Fabrication</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../style.css" rel="stylesheet">
  <style>
    .media-equal {
      width: 100%;
      max-width: 400px;
      height: 450px;
      object-fit: cover;
      border-radius: 8px;
    }

    video.media-equal {
      display: block;
    }

    pre {
      background-color: #f8f9fa;
      padding: 1rem;
      overflow-x: auto;
      border-radius: 6px;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-sm navbar-dark" style="color: #EEE7E8;">
    <div class="container-fluid" style="align-items: center; justify-content: center;">
      <div class="flexrow">
        <h2 class="nav-title">PHYS S-12 Summer 2025</h2>
      </div>
      <div class="navbar-nav">
        <h4><a class="nav-link" href="../index.html">Home</a></h4>
        <h4><a class="nav-link" href="../about.html">About</a></h4>
      </div>
    </div>
  </nav>

  <div class="textcontainer p-4">
    <h3>Week 9: Radio, WiFi, Bluetooth (IoT)</h3>
    <h4>Assignment: Program something with IoT</h4>

    <p>This week I focused on building a system that connects the Shopify API to my MVP that I made. My original goal was to have every order increment my physical counter, but I ran out of time to finish that part. I’ll keep working on it next week.</p>

    <h5>Step 1: Shopify → Firebase Integration</h5>
    <p>I wrote a webhook server that listens for new Shopify orders and pushes them to Firebase. Every time an order is placed, the database logs the data and increments a counter.</p>

    <img src="./firebase.png" width="1000" class="img-fluid mb-4" alt="Shopify to Firebase flow">

    <p>This part was tricky, there are basically no tutorials online for doing this exact setup. I’ve never worked with databases or cloud functions before, so I had to figure most of it out myself. I used ChatGPT a lot and Googled every roadblock. With a bunch of trial and error, I finally got everything working smoothly.</p>

    <pre><code class="language-js">
// server.js
const express = require('express');
const bodyParser = require('body-parser');
const admin = require('firebase-admin');
const crypto = require('crypto');
const app = express();

function verifyShopifyWebhook(req, res, buf) {
  const hmacHeader = req.get('X-Shopify-Hmac-Sha256');
  const generatedHmac = crypto
    .createHmac('sha256', process.env.SHOPIFY_WEBHOOK_SECRET)
    .update(buf, 'utf8')
    .digest('base64');

  if (generatedHmac !== hmacHeader) {
    throw new Error('Webhook signature mismatch');
  }
}

app.use(bodyParser.json({ verify: verifyShopifyWebhook }));

const serviceAccount = {
  type: "service_account",
  project_id: process.env.FIREBASE_PROJECT_ID,
  private_key: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n'),
  client_email: process.env.FIREBASE_CLIENT_EMAIL,
  token_uri: "https://oauth2.googleapis.com/token",
};

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: 'https://shopify-counter-688ee-default-rtdb.firebaseio.com',
});

const db = admin.database();

app.post('/webhook', (req, res) => {
  const order = req.body;

  const filteredData = {
    order_id: order.id,
    created_at: order.created_at,
    email: order.email,
    name: order.name,
    total_price: order.total_price,
    currency: order.currency,
    line_items: order.line_items.map(item => ({
      title: item.title,
      quantity: item.quantity,
      price: item.price,
    })),
    shipping_address: order.shipping_address
      ? {
          name: order.shipping_address.name,
          address1: order.shipping_address.address1,
          city: order.shipping_address.city,
          zip: order.shipping_address.zip,
          province: order.shipping_address.province,
          country: order.shipping_address.country,
        }
      : null,
  };

  console.log('✅ Order received:', filteredData);

  db.ref('shopify/orders').push(filteredData)
    .then(() => res.status(200).send('OK'))
    .catch(err => {
      console.error('❌ Firebase error:', err);
      res.status(500).send('Error');
    });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`🚀 Server running on port ${PORT}`));
    </code></pre>

    <p>This worked flawlessly. I was able to test live orders and saw the counter increment in Firebase in real time.</p>

    <img src="./firebase-counter.png" width="1000" class="img-fluid mb-4" alt="Firebase order counter screenshot">

    <h5>Step 2: Arduino Integration (Next Week)</h5>
    <p>I planned to connect Firebase to my ESP32 to react when orders come in, but I didn’t have enough time and energy to finish this part. It’s top of my list for next week and I’m excited to get it working.</p>

    <h5>Bonus: Candy Dispenser Project</h5>
    <p>On the side, I also built a candy dispenser using a 3D-printed STL I found online and a servo motor. It dispenses a piece of candy when a button is pressed online.</p>

    <div class="row mb-4">
      <div class="col-md-6 mb-3">
        <img src="./finished.JPG" class="media-equal" alt="Candy dispenser front">
      </div>
      <div class="col-md-6 mb-3">
        <video class="media-equal" autoplay muted loop playsinline>
          <source src="./working.webm" type="video/webm">
        </video>
      </div>
    </div>
    <div class="row mb-4">
      <div class="col-md-6 mb-3">
        <img src="./wiring.JPG" class="media-equal" alt="Candy dispenser wiring">
      </div>
      <div class="col-md-6 mb-3">
        <video class="media-equal" autoplay muted loop playsinline>
          <source src="./dispensing.webm" type="video/webm">
        </video>
      </div>
    </div>

    <pre><code class="language-cpp">
// Candy Dispenser Arduino Code
#include <WiFi.h>
#include <ESP32Servo.h>

Servo myservo;
int servoPin = 26;
int pos = 0;
char state='-';

const char *ssid = "MAKERSPACE";
const char *password = "12345678";

NetworkServer server(80);

void setup() {
  ESP32PWM::allocateTimer(0);
  ESP32PWM::allocateTimer(1);
  ESP32PWM::allocateTimer(2);
  ESP32PWM::allocateTimer(3);
  myservo.setPeriodHertz(50);
  myservo.attach(servoPin, 1000, 2000);

  myservo.write(pos);

  Serial.begin(115200);
  pinMode(2, OUTPUT);
  delay(10);

  Serial.println();
  Serial.println("Connecting to ");
  Serial.println(ssid);

  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("");
  Serial.println("WiFi connected.");
  Serial.println("IP address: ");
  Serial.println(WiFi.localIP());

  server.begin();
}

void loop() {
  NetworkClient client = server.accept();

  if (client) {
    Serial.println("New Client.");
    String currentLine = "";
    while (client.connected()) {
      if (client.available()) {
        char c = client.read();
        Serial.write(c);
        if (c == '\n') {
          if (currentLine.length() == 0) {
            client.println("HTTP/1.1 200 OK");
            client.println("Content-type:text/html");
            client.println();
            client.print("Click <a href=\"/C\">here</a> to get candy!.<br>");
            client.println();
            break;
          } else {
            currentLine = "";
          }
        } else if (c != '\r') {
          currentLine += c;
        }

        if (currentLine.endsWith("GET /C")) {
          state = 'c';
        }

        if (state == 'c') {
          while (pos <= 150) {
            pos += 10;
            myservo.write(pos);
            delay(15);
          }
          while (pos >= 0) {
            pos -= 10;
            myservo.write(pos);
            delay(15);
          }
          state = '-';
        }
      }
    }
    client.stop();
    Serial.println("Client Disconnected.");
  }
}
    </code></pre>

    <h5>Reflection:</h5>
    <p>This was one of the most exciting projects so far. I learned a ton about working with webhooks, real-time databases, and cloud servers. Even though I didn’t finish everything, I made major progress and laid the foundation to finish it soon.</p>

    <h5>Download Files:</h5>
    <p><a href="./week9.zip" download>Click here to download all project files (literally just the candy dispenser stl)</a></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>